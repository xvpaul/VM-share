# Upstream (your FastAPI on localhost:8000)
upstream fastapi_app {
  server 127.0.0.1:8000;
}

server {
  listen 80;
  server_name _;

  # Basic security + proxy headers
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Long timeouts for VNC/WebSockets
  proxy_read_timeout  86400s;
  proxy_send_timeout  86400s;

  # ---- Static files
  location /static/ {
    # change this to your actual static dir
    alias /app/static/;
    access_log off;
    expires 7d;
    add_header Cache-Control "public, max-age=604800, immutable";
    try_files $uri =404;
  }

  # noVNC UI (adjust path)
  location /novnc/ {
    alias /app/static/novnc-ui/;
    index vnc.html;
    access_log off;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
    try_files $uri $uri/ /novnc/vnc.html;
  }

  # ---- FastAPI (REST/docs)
  location /api/   { proxy_pass http://fastapi_app; }
  location /docs   { proxy_pass http://fastapi_app; }
  location /redoc  { proxy_pass http://fastapi_app; }
  location = /healthz { proxy_pass http://fastapi_app/healthz; }

  # Root → app (if you serve index via FastAPI)
  location = / {
    try_files /static/index.html @app;
  }
  location @app { proxy_pass http://fastapi_app; }

  # ---- WebSockets (your FastAPI endpoints under /ws/)
  location /ws/ {
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_pass http://fastapi_app;
  }

  # ---- Websockify dynamic ports: /vnc/<port>/... → 127.0.0.1:<port>/
#   location ~ ^/vnc/(?<port>\d+)/(.*)$ {
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection "upgrade";
#     proxy_read_timeout 86400s;
#     proxy_send_timeout 86400s;
#     proxy_pass http://127.0.0.1:$port/$2;
#   }

  client_max_body_size 50m;
}
